# pentesting/masscan_scan.py
import subprocess

def run_masscan_scan(target, subnet, port_range):
    try:
        # Validate port range input
        if port_range == "all":
            ports = "0-65535"
        elif port_range == "top1000":
            ports = "1-1000"
        else:
            ports = port_range  # e.g., "22,80,443"

        # If subnet is true, treat target as a /24 subnet
        if subnet:
            target = f"{target}/24"

        # Masscan basic command
        cmd = [
            "masscan",
            target,
            "-p", ports,
            "--rate", "1000"  # example: limit packets/sec to avoid flooding
        ]

        print(f"Running Masscan command: {' '.join(cmd)}")
        result = subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True)
        return result

    except subprocess.CalledProcessError as e:
        return f"Masscan scan failed:\n{e.output}"
    except Exception as e:
        return f"Unexpected error:\n{e}"
