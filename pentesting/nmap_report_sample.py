import subprocess
import re
from datetime import datetime

# Example target
target_ip = "10.0.2.15"

# Run Nmap scan command via subprocess (you can add -O for OS detection)
def run_nmap_scan(ip):
    try:
        result = subprocess.run(
            ["nmap", "-sV", "-O", ip],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            check=True
        )
        return result.stdout
    except subprocess.CalledProcessError as e:
        print("Error running nmap:", e)
        return ""

# Parse raw Nmap output to extract findings
def parse_nmap_output(raw_output):
    findings = {
        "ip": None,
        "ports": [],
        "os": None
    }

    # Extract IP address from Nmap report line
    ip_match = re.search(r"Nmap scan report for ([\d\.]+)", raw_output)
    if ip_match:
        findings["ip"] = ip_match.group(1)

    # Extract open ports and service details
    port_lines = re.findall(r"(\d+/tcp)\s+open\s+(\S+)\s+([^\n]*)", raw_output)
    for port, service, version in port_lines:
        findings["ports"].append({
            "port": port,
            "service": service,
            "version": version.strip()
        })

    # Extract OS detection result (if available)
    os_match = re.search(r"OS details: (.+)", raw_output)
    if os_match:
        findings["os"] = os_match.group(1)

    return findings

# Example usage:
raw_output = run_nmap_scan(target_ip)
findings = parse_nmap_output(raw_output)

# Show parsed findings
print("Parsed Findings:")
print(findings)
